#!/bin/bash

# Generate the table.md file which is shown on the Git project repository.

main() {
    header
    originals
    variants
    others
}

header() {
    cat <<-EOF
<!-- autogenerated by adjunct/mkmdtable on $(date -u) -->
## Table of ROM checksums

Here are the CRC-16/XModem values for all of the Model T ROMs which
have been reported so far. If you find one not listed, please open an
[issue](issues) so it can be added to the list. Ideally, include a
copy of your ROM, but at a minimum, please include the calculated CRC
and a name to call your variation.

[issues]: https://github.com/hackerb9/crc16-modelt/issues "Report a bug"

EOF
}

originals() {
    echo
    echo '### Original system ROMs'
    echo "The system ROMs as they came from the factory back in the 1980s."
    makemarkdowntable ROMs/*orig.bin
}

variants() {
    echo
    echo '### ROM Variants'
cat <<-EOF
Modified ROMs will have different checksums than the original. Examples:
* Y2K patches

* The Virtual T emulator can dynamically update the ROMs to show the
  version on the main menu. 

* Stephen Adolph's "[REX Classic][rexclassic]" Option ROM could
  replace the system ROM with a modified version for "[Main ROM
  Management][rexmanagement]".

[rexclassic]: https://github.com/bkw777/REX_Classic "Rex Classic Respin by BKW"
[rexmanagement]: https://bitchin100.com/wiki/index.php?title=Main_ROM_Management_Feature

See also this project's [directory of sample ROMs](ROMs). The files
are mostly mirrored from https://tandy.wiki/), but renamed so that
variations are listed after a plus sign.
EOF
    local files=$(ls ROMs/*.bin | grep -v orig.bin$)
    makemarkdowntable $files
}

others() {
    echo
    echo '### Other related ROMs'

    cat <<-EOF
These ROMs are not system ROMs for Kyotronic-like computers, but they
are related.
EOF
    makemarkdowntable  ROMs/other/*.bin
}


makemarkdowntable() {
    {
	echo "|Machine Name|Version|CRC-16|ROM size|"
	echo "|------------|-------|-----:|-------:|"
	join -j2  <(./crc16 "$@")  <(ls -hs1 "$@")  |
	    awk '{
	    	file=$1;
	        variant=gensub(/.*\+/, "", "1", $1);
    		gsub(/^_+|_+$/, "", variant);
    		gsub(/_+/, ", ", variant); 
    		gsub(/\.bin$/, "", variant);	
    		gsub(/_+/, " ", $1); 
    		gsub(/^ +| +$/, "", $1);
	        gsub(/\+.*/, "", $1);
	        gsub(/^.*\//, "", $1);
		printf("| [%s](%s) | %s | %s | %s |\n", $1, file, variant, $2, $3, $4);
            }'  
    }
	
}



main "$@"
