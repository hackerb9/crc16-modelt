#!/bin/bash

# Generate the table.md file which is shown on the Git project repository.

main() {
    header
    originals
    variants
    others
}

header() {
    cat <<-EOF
<!-- autogenerated by adjunct/mkmdtable on $(date -u) -->
## Table of ROM checksums

Here are the CRC-16/XModem values for all of the Model T ROMs which
have been reported so far. If you find one not listed, please open an
[issue](issues) so it can be added to the list. Ideally, include a
copy of your ROM, but at a minimum, please include the calculated CRC
and a name to call your variation.

[issues]: https://github.com/hackerb9/crc16-modelt/issues "Report a bug"

EOF
}

originals() {
    echo
    echo '### Original system ROMs'
    echo "The system ROMs as they came from the factory back in the 1980s."
    makemarkdowntable ROMs/*orig.bin
}

variants() {
    echo
    echo '### ROM Variants'
cat <<-EOF
Modified ROMs, for example with Y2K patches, will have different
checksums than the original. The Virtual T emulator can also
dynamically patch the ROMs to show the version on the Menu. See also
the [directory of sample ROMs](ROMs), (mirrored from
[tandy.wiki][tandy.wiki]).

[tandy.wiki]: http://tandy.wiki/Model_T_System_ROMs "List of system ROMs, the builtin software on a chip"
EOF
    local files=$(ls ROMs/*.bin | grep -v orig.bin$)
    makemarkdowntable $files
}

others() {
    echo
    echo '### Other related ROMs'

    cat <<-EOF
These ROMs are not system ROMs for Kyotronic-like computers, but they
are related.
EOF
    makemarkdowntable  ROMs/other/*.bin
}


makemarkdowntable() {
    {
	echo "|Machine Name|Version|CRC-16|ROM size|"
	echo "|------------|-------|-----:|-------:|"
	join -j2  <(./crc16 "$@")  <(ls -hs1 "$@")  |
	    awk '{
	        sub(/\+/, "|", $1);
	        gsub(/^.*\//, "", $1);
    		gsub(/\.bin$/, "", $1);	
    		gsub(/_+/, " ", $1); 
    		gsub(/^ +| +$/, "", $1);
		print "|" $1 " | " $2 " | " $3 "|";
            }'  
    } | column -t -s\| -o\|
	
}



main "$@"
